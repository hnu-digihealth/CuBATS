

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cubats.slide_collection.slide_collection &mdash; CuBATS 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/CuBATS_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User-Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CuBATS Architecture</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../slide_collection.html">Slide Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../registration.html">Image Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../segmentation.html">Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantification.html">Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../colocalization.html">Co-Expression Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CuBATS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cubats.slide_collection.slide_collection</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cubats.slide_collection.slide_collection</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard Library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging.config</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>

<span class="c1"># Third Party</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># CuBATS</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cubats.cutils</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cutils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cubats.logging_config</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">log_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cubats.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_backend_info</span><span class="p">,</span> <span class="n">xp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cubats.slide_collection.registration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">register_slides</span><span class="p">,</span> <span class="n">register_slides_high_resolution</span><span class="p">,</span>
    <span class="n">register_slides_with_reference</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cubats.slide_collection.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_tumor_segmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cubats.slide_collection.slide</span><span class="w"> </span><span class="kn">import</span> <span class="n">Slide</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cubats.slide_collection.tile_colocalization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">evaluate_antigen_pair_tile</span><span class="p">,</span> <span class="n">evaluate_antigen_triplet_tile</span><span class="p">)</span>

<span class="c1"># Constants</span>
<span class="c1"># Destination directories</span>
<span class="n">RESULT_DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="n">REGISTRATION_DIR</span> <span class="o">=</span> <span class="s2">&quot;registration&quot;</span>
<span class="n">TILES_DIR</span> <span class="o">=</span> <span class="s2">&quot;tiles&quot;</span>
<span class="n">COLOCALIZATION</span> <span class="o">=</span> <span class="s2">&quot;colocalization&quot;</span>
<span class="n">ORIGINAL_TILES_DIR</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span>  <span class="c1"># TODO: remove if no further use</span>
<span class="n">DAB_TILE_DIR</span> <span class="o">=</span> <span class="s2">&quot;dab&quot;</span>
<span class="n">E_TILE_DIR</span> <span class="o">=</span> <span class="s2">&quot;eosin&quot;</span>  <span class="c1"># TODO: remove if no further use</span>
<span class="n">H_TILE_DIR</span> <span class="o">=</span> <span class="s2">&quot;hematoxylin&quot;</span>  <span class="c1"># TODO: remove if no further use</span>
<span class="n">PICKLE_DIR</span> <span class="o">=</span> <span class="s2">&quot;pickle&quot;</span>
<span class="n">RECONSTRUCT_DIR</span> <span class="o">=</span> <span class="s2">&quot;reconstructed_slides&quot;</span>
<span class="n">SLIDE_COLLECTION_COLUMN_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Reference&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mask&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Openslide Object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tiles&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Level Count&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Level Dimensions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tile Count&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SUPPORTED_IMAGE_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.mrxs&quot;</span><span class="p">,</span> <span class="s2">&quot;.svs&quot;</span><span class="p">]</span>
<span class="c1"># Define column names and data types</span>
<span class="n">QUANTIFICATION_RESULTS_COLUMN_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Coverage (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;High Positive (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Medium Positive (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Low Positive (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Negative (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Background / No Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Non-mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;H-Score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Score&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Total Processed Tiles (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Error (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">DUAL_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Slide 1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Slide 2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Total Coverage (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;High Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;High Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Medium Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Medium Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Low Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Low Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Negative Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Background / No Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Non-mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Processed Tiles (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Error (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Error1 (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Error2 (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">TRIPLET_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Slide 1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Slide 2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Slide 3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Total Coverage (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;High Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;High Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Medium Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Medium Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Low Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Low Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Negative Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Background / No Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Non-mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Total Error (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Error1 (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Error2 (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Thresholds3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">DEFAULT_TILE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>


<div class="viewcode-block" id="SlideCollection">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SlideCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a slide collection, stores slide info and performs slide processing.</span>

<span class="sd">    `SlideCollection` is a class that initializes a collection of slides, stores relevant processing information,</span>
<span class="sd">    and allows the execution of separate processing steps. Previously processed data can be reloaded.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Name of parent directory (i.e. name of tumorset).</span>

<span class="sd">        src_dir (str): Path to source directory containing the WSIs.</span>

<span class="sd">        dest_dir (str): Path to destination directory for results.</span>

<span class="sd">        data_dir (str): Path to data directory, a subdirectory of `dest_dir`. The directory will be initiaded upon class</span>
<span class="sd">            creation inside the `dest_dir`. Inside the data directory summaries of quantification results, dual antigen</span>
<span class="sd">            expression results and triplet antigen expression results are stored as .CSV file.</span>
<span class="sd">            The data_dir also contains the `pickle_dir`.</span>

<span class="sd">        pickle_dir (str): Path to pickle directory, a subdirectory of `data_dir`. Inside the pickle directory pickled</span>
<span class="sd">            copies of the slide_collection, quantification results and antigen analysis are stored which will be</span>
<span class="sd">            automatically reloaded if a slide collection is (re-)initialized with the same output_dir.</span>

<span class="sd">        tiles_dir (str): Path to tiles directory, a subdirectory of `dest_dir`. Inside the tiles directory the tile</span>
<span class="sd">            directories for each slide are stored.</span>

<span class="sd">        colocalization_dir (str): Path to colocalization directory, a subdirectory of `dest_dir`. Inside the</span>
<span class="sd">            colocalization directory results of dual and triplet overlap analyses are stored.</span>

<span class="sd">        reconstruct_dir (str): Path to reconstruct directory, a subdirectory of `dest_dir`. Inside the reconstruct</span>
<span class="sd">            directory reconstructed slides are stored.</span>

<span class="sd">        collection_list (list of Slide): list containing all slide objects.</span>

<span class="sd">        collection_info_df (Dataframe): Dataframe containing relevant information on all the slides. The colums are:</span>

<span class="sd">            - Name (str): Name of slide.</span>
<span class="sd">            - Reference (bool): True if slide is reference slide.</span>
<span class="sd">            - Mask (bool): True if slide is mask slide.</span>
<span class="sd">            - OpenSlide Object (OpenSlide): OpenSlide object of the slide.</span>
<span class="sd">            - Tiles (DeepZoomGenerator): DeepZoom tiles of the slide.</span>
<span class="sd">            - Level Count (int): Number of Deep Zoom levels in the image.</span>
<span class="sd">            - Level Dimensions (list): List of tuples (pixels_x, pixels_y) for each Deep Zoom level.</span>
<span class="sd">            - Tile Count (int): Number of total tiles in the image.</span>

<span class="sd">        mask (Slide): Mask slide of the collection. Is set during initialization.</span>

<span class="sd">        mask_coordinates (list): List containing the tile coordinates for tiles that are covered by the mask</span>
<span class="sd">            Coordinates are tuples (column, row). TODO eliminate by using internal methods for applying mask to Image.</span>

<span class="sd">        quantification_results (Dataframe): Dataframe containing the quantification results for all processed slides.</span>
<span class="sd">            The columns are:</span>

<span class="sd">            - Name (str): Name of the slide.</span>

<span class="sd">            - Coverage (%) (float): Positively stained pixels in the slide, characterizing the tumor coverage.</span>

<span class="sd">            - High Positive (%) (float): Percentage of highly positive stained pixels in the slide.</span>

<span class="sd">            - Medium Positive (%) (float): Percentage of medium positive stained pixels in the slide.</span>

<span class="sd">            - Low Positive (%) (float): Percentage of low positive stained pixels in the slide.</span>

<span class="sd">            - Negative (%) (float): Percentage negatively stained pixels in the slide.</span>

<span class="sd">            - Total Tissue (%) (float): Total amount of tissue in the slide.</span>

<span class="sd">            - Background / No Tissue (%) (float): Percentage of background and non-tissue regions in the slide.</span>

<span class="sd">            - Mask Area (%) (float): Area of the slide covered by the tumor mask.</span>

<span class="sd">            - Non-mask Area (%) (float): Area of the slide not covered by the tumor mask.</span>

<span class="sd">            - H-Score (float): Established pathological score calculated based on the distribution of staining</span>
<span class="sd">              intensities in the slide.</span>

<span class="sd">            - Score (str): Additional overall score of the slide calculated from the average of scores for all tiles.</span>
<span class="sd">              However, this score may be misleading, as it is an average over the entire slide. TODO necessary?</span>

<span class="sd">            - Total Processed Tiles (%) (float): Percentage of processed tiles.</span>

<span class="sd">            - Error (%) (float): Percentage of tiles that were not processed due to insufficient tissue coverage.</span>
<span class="sd">              Only the case for tile-level masking.</span>

<span class="sd">            - Thresholds (list): List containing the thresholds applied during quantification.</span>

<span class="sd">        dual_antigen_expressions (Dataframe): Dataframe containing a summary of the dual antigen expression results</span>
<span class="sd">            for all processed analyses:</span>

<span class="sd">            - Slide 1 (str): Name of the first slide.</span>

<span class="sd">            - Slide 2 (str): Name of the second slide.</span>

<span class="sd">            - Total Coverage (%) (float): Percentage of combined coverage in two slides.</span>

<span class="sd">            - Total Overlap (%) (float: Percentage of overlapping antigen expressions in two slides.</span>

<span class="sd">            - Total Complement (%) (float): Percentage of complementary antigen expressions in two slides.</span>

<span class="sd">            - High Positive Overlap (%) (float): Percentage of highly positive overlapping antigen expressions in</span>
<span class="sd">              two slides.</span>

<span class="sd">            - High Positive Complement (%) (float): Percentage of highly positive complementary antigen expressions in</span>
<span class="sd">              two slides.</span>

<span class="sd">            - Medium Positive Overlap (%) (float): Percentage of medium positive overlapping antigen expressions in</span>
<span class="sd">              two slides.</span>

<span class="sd">            - Medium Positive Complement (%) (float): Percentage of medium positive complementary antigen expressions</span>
<span class="sd">              in two slides.</span>

<span class="sd">            - Low Positive Overlap (%) (float): Percentage of low positive overlapping antigen expressions in</span>
<span class="sd">              two slides.</span>

<span class="sd">            - Low Positive Complement (%) (float): Percentage of low positive complementary antigen expressions in</span>
<span class="sd">              two slides.</span>

<span class="sd">            - Negative Tissue (%) (float): Percentage of negative tissue in the two slides.</span>

<span class="sd">            - Total Tissue (%) (float): Percentage of total tissue in the two slides.</span>

<span class="sd">            - Background / No Tissue (%) (float): Percentage of background and non-tissue regions in the two slides.</span>

<span class="sd">            - Total Processed Tiles (%) (float): Percentage of processed tiles.</span>

<span class="sd">            - Total Error (%) (float): Percentage of tiles that were not processed due to insufficient tissue coverage.</span>

<span class="sd">            - Error1 (%) (float): Percentage of tiles where neither tile contained tissue.</span>

<span class="sd">            - Error2 (%) (float): Percentage of tiles where tiles could not be analyzed due to incorrect tile shapes.</span>

<span class="sd">            - Thresholds1 (str): Antigen thresholds for slide 1.</span>

<span class="sd">            - Thresholds2 (str): Antigen thresholds for slide 2</span>

<span class="sd">        triplet_antigen_results (Dataframe): Dataframe containing a summary of the triplet antigen expression results</span>
<span class="sd">            for all processed analyses:</span>

<span class="sd">            - Slide 1 (str): Name of the first slide.</span>

<span class="sd">            - Slide 2 (str): Name of the second slide.</span>

<span class="sd">            - Slide 3 (str): Name of the third slide.</span>

<span class="sd">            - Total Coverage (%) (float): Percentage of combined coverage in three slides.</span>

<span class="sd">            - Total Overlap (%) (float: Percentage of overlapping antigen expressions in three slides.</span>

<span class="sd">            - Total Complement (%) (float): Percentage of complementary antigen expressions in three slides.</span>

<span class="sd">            - High Positive Overlap (%) (float): Percentage of highly positive overlapping antigen expressions in</span>
<span class="sd">              three slides.</span>

<span class="sd">            - High Positive Complement (%) (float): Percentage of highly positive complementary antigen expressions in</span>
<span class="sd">              three slides.</span>

<span class="sd">            - Medium Positive Overlap (%) (float): Percentage of medium positive overlapping antigen expressions in</span>
<span class="sd">              three slides.</span>

<span class="sd">            - Medium Positive Complement (%) (float): Percentage of medium positive complementary antigen expressions</span>
<span class="sd">              in three slides.</span>

<span class="sd">            - Low Positive Overlap (%) (float): Percentage of low positive overlapping antigen expressions in</span>
<span class="sd">              three slides.</span>

<span class="sd">            - Low Positive Complement (%) (float): Percentage of low positive complementary antigen expressions in</span>
<span class="sd">              three slides.</span>

<span class="sd">            - Negative Tissue (%) (float): Percentage of negative tissue in the three slides.</span>

<span class="sd">            - Total Tissue (%) (float): Percentage of total tissue in the three slides.</span>

<span class="sd">            - Background / No Tissue (%) (float): Percentage of background and non-tissue regions in the three slides.</span>

<span class="sd">            - Total Processed Tiles (%) (float): Percentage of processed tiles.</span>

<span class="sd">            - Total Error (%) (float): Percentage of tiles that were not processed due to insufficient tissue coverage.</span>

<span class="sd">            - Error1 (%) (float): Percentage of tiles where neither tile contained tissue.</span>

<span class="sd">            - Error2 (%) (float): Percentage of tiles where tiles could not be analyzed due to incorrect tile shapes.</span>

<span class="sd">            - Thresholds1 (str): Antigen thresholds for slide 1.</span>

<span class="sd">            - Thresholds2 (str): Antigen thresholds for slide 2</span>

<span class="sd">            - Thresholds3 (str): Antigen thresholds for slide 3</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlideCollection.__init__">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">,</span>
        <span class="n">src_dir</span><span class="p">,</span>
        <span class="n">dest_dir</span><span class="p">,</span>
        <span class="n">ref_slide</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">path_antigen_profiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the class. The class contains information on the slide collection.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_name (str): Name of the collection (i.e. Name of tumor set or patient ID)</span>

<span class="sd">            src_dir (str): Path to src directory containing the WSIs.</span>

<span class="sd">            dest_dir (str): Path to destination directory for results.</span>

<span class="sd">            ref_slide (str, optional): Path to reference slide. If &#39;ref_slide&#39; is None it will be automatically set to</span>
<span class="sd">                the HE slide based on the filename of input files. Defaults to None.</span>

<span class="sd">            path_antigen_profiles (str, optional): Path to antigen profiles. Definitions as .json or .csv are accepted.</span>
<span class="sd">                If no default thresholds will be applied during processing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">log_config</span><span class="o">.</span><span class="n">LOGGING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># Name of the tumorset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>

        <span class="c1"># Validate directories</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Source directory </span><span class="si">{</span><span class="n">src_dir</span><span class="si">}</span><span class="s2"> does not exist or is not accessible.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Destination directory </span><span class="si">{</span><span class="n">dest_dir</span><span class="si">}</span><span class="s2"> does not exist or is not accessible.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span> <span class="o">=</span> <span class="n">src_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span> <span class="o">=</span> <span class="n">dest_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconstruct_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># List containing all slide objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Slide informations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">SLIDE_COLLECTION_COLUMN_NAMES</span><span class="p">)</span>

        <span class="c1"># Mask Variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># TODO remove and replace</span>

        <span class="c1"># Reference Slide</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span> <span class="o">=</span> <span class="n">ref_slide</span>

        <span class="c1"># Quantification Variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">QUANTIFICATION_RESULTS_COLUMN_NAMES</span>
        <span class="p">)</span>

        <span class="c1"># Antigen Expression Variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">DUAL_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">TRIPLET_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;initialized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;registered&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;segmented&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;quantified&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;dual_antigen_expression&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;triplet_antigen_expression&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Set destination directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dst_dir</span><span class="p">()</span>

        <span class="c1"># Initialize the slide collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_slide_collection</span><span class="p">()</span>

        <span class="c1"># Load previous results if exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_previous_results</span><span class="p">()</span>
        <span class="c1"># if not self.mask_coordinates:</span>
        <span class="c1">#    self.extract_mask_tile_coordinates()</span>

        <span class="k">if</span> <span class="n">path_antigen_profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_antigen_profiles</span><span class="p">(</span><span class="n">path_antigen_profiles</span><span class="p">)</span>

        <span class="c1"># Log initialization details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Initialized SlideCollection with collection_name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;src_dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="si">}</span><span class="s2">, dest_dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ref_slide: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;backend: </span><span class="si">{</span><span class="n">get_backend_info</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_dst_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign and initiate needed directories if they do not exist yet.&quot;&quot;&quot;</span>
        <span class="c1"># Data dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">RESULT_DATA_DIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Pickle dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">PICKLE_DIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Data and Pickle directories created&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_slide_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the slide collection by iterating over the files in the source directory. Only files with the</span>
<span class="sd">        extensions &#39;.tiff&#39; or &#39;.tif&#39; are considered. For each valid file, a &#39;Slide&#39; object is created. Each Slide&#39;s</span>
<span class="sd">        information is added to the &#39;collection_info_df&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">            TODO: Check indexing of collection_info_df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing SlideCollection: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">init_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)):</span>
                <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="n">SUPPORTED_IMAGE_FORMATS</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Look for mask and reference slide. If no reference selected HE slide will be selected</span>
                    <span class="c1"># if re.search(&quot;_mask&quot;, filename):</span>
                    <span class="c1">#    mask = True</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;HE&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span><span class="p">:</span>
                        <span class="n">ref</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">slide</span> <span class="o">=</span> <span class="n">Slide</span><span class="p">(</span>
                        <span class="n">filename</span><span class="p">,</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
                        <span class="n">is_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">is_reference</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ref</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span> <span class="o">=</span> <span class="n">slide</span>
                    <span class="c1"># elif mask:</span>
                    <span class="c1">#    self.mask = slide</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;collection_info.csv&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;initialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">init_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Slide collection initialized in </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">init_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">init_start_time</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_previous_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads results from previous processing if they exist.</span>

<span class="sd">        Tries to load results from previous processing. If no path is passed, the collections `pickle_dir` is used.</span>
<span class="sd">        Slide objects are based on `OpenSlid` which are C-type objects and cannot be stored as pickle. Therefore, each</span>
<span class="sd">        Slide is re-initialized in the init_slide_collection function. The function will try to load the following</span>
<span class="sd">        files:</span>

<span class="sd">            - mask_coordinates.pickle: Load mask coordinates from previous mask processing.</span>

<span class="sd">            - quantification_results.pickle: Load quantification results from previous processing.</span>

<span class="sd">            - dual_antigen_expressions.pickle: Load dual antigen overlap results from previous processing.</span>

<span class="sd">            - triplet_antigen_expressions.pickle: Load triplet antigen overlap results from previous processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str, optional): Path to directory containing pickle files. Defaults to `pickle_dir` of the slide</span>
<span class="sd">                collection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prev_res_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for previous results&quot;</span><span class="p">)</span>

        <span class="n">reg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">REGISTRATION_DIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span> <span class="o">=</span> <span class="n">reg_dir</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for previous registration results&quot;</span><span class="p">)</span>
                <span class="c1"># update Slide objects to point to registered images</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_slide_paths_after_registration</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;registered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Successfully loaded registered slides into </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to update slide paths from existing registration directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for previous segmentation results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_mask_to_collection</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for previous quantification results&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span>
            <span class="n">path_mask_coord</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;mask_coordinates.pickle&quot;</span><span class="p">)</span>
            <span class="n">path_quant_res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;quantification_results.pickle&quot;</span><span class="p">)</span>
            <span class="n">path_dual_overlap_res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;dual_antigen_expressions.pickle&quot;</span>
            <span class="p">)</span>
            <span class="n">path_triplet_overlap_res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;triplet_antigen_expressions.pickle&quot;</span>
            <span class="p">)</span>

            <span class="c1"># load mask coordinates</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_mask_coord</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path_mask_coord</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;segmented&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Successfully loaded mask coordinates for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No mask coordinates found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># load quantification results</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_quant_res</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path_quant_res</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;quantified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Sucessfully loaded quantification results for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No previous quantification results found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># load dual overlap results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for previous dual antigen expression results&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_dual_overlap_res</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">path_dual_overlap_res</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;dual_antigen_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Successfully loaded dual_antigen_expression results for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No previous dual_antigen_expression results found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># load triplet overlap results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Searching for previous triplet antigen expression results&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_triplet_overlap_res</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">path_triplet_overlap_res</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;triplet_antigen_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Successfully loaded triplet_antigen_expression results for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No previous triplet_antigen_expression results found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Load processing info for each slide TODO load into slide object</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
                <span class="n">path_slide</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_processing_info.pickle&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_slide</span><span class="p">):</span>
                    <span class="n">slide</span><span class="o">.</span><span class="n">detailed_quantification_results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">path_slide</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Successfully loaded processing info for slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># If quantification results for loaded slide exist, load them into the slide object</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slide</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">slide</span><span class="o">.</span><span class="n">quantification_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slide</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Successfully loaded detailed quantification results for slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;No quantification results found for slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No previous processing info found for slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">pass</span>
        <span class="n">prev_res_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished loading previous results for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">prev_res_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_res_start_time</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_mask_to_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a mask slide to the slide collection.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir (str): Path to directory the mask is in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">dir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Registration directory </span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s2"> does not exist yet. Please run registration first.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_IMAGE_FORMATS</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">mask_name</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">mask_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
                        <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_mask</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update_slide</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Could not update existing mask slide path for </span><span class="si">{</span><span class="n">mask_name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">Slide</span><span class="p">(</span><span class="n">mask_name</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">,</span> <span class="n">is_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_mask</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_info</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">new_mask</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;Could not append new mask slide to collection_info&quot;</span>
                                <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">new_mask</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found mask Slide but failed to load it: </span><span class="si">{</span><span class="n">mask_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded mask slide from directory: </span><span class="si">{</span><span class="n">mask_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while scanning </span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s2"> for mask: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SlideCollection.extract_mask_tile_coordinates">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.extract_mask_tile_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_mask_tile_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_img</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts mask coordinates from the mask slide.</span>

<span class="sd">        Generates a list containing of tiles coordinates that are part of the mask. This allows to only process tiles</span>
<span class="sd">        that are part of the mask and thus contain tumor tissue. Tiles with less than 10% tumor tissue are dropped due</span>
<span class="sd">        to save runtime. Previous mask coordinates will be overwritten and the results will be stored as pickle in</span>
<span class="sd">        `pickle_dir`.</span>

<span class="sd">        Args:</span>
<span class="sd">            save_img (bool): Boolean to determine if mask tiles shall be saved as image. Necessary if mask shall be</span>
<span class="sd">                reconstructed later on. Note: Storing tiles will require addition storage. Defaults to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create tiles directory if it does not exist</span>
        <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">TILES_DIR</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># If no mask slide is provided, mask coordinates will contain all tiles of the slide.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">slide_tiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tiles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">slide_tiles</span><span class="o">.</span><span class="n">level_tiles</span><span class="p">[</span><span class="n">slide_tiles</span><span class="o">.</span><span class="n">level_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting mask tiles&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Extracting Mask Tile Coordinates&quot;</span><span class="p">)</span>
            <span class="n">mask_tiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">tiles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">mask_tiles</span><span class="o">.</span><span class="n">level_tiles</span><span class="p">[</span><span class="n">mask_tiles</span><span class="o">.</span><span class="n">level_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting mask tiles&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">mask_tiles</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">mask_tiles</span><span class="o">.</span><span class="n">level_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;RGB&quot;</span><span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RBG&quot;</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="n">mean</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

                    <span class="c1"># If tile is mostly white, drop tile coordinate; cutoff: 230 (10%)</span>
                    <span class="k">if</span> <span class="n">mean</span> <span class="o">&lt;</span> <span class="mi">230</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
                            <span class="n">tile_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="c1"># Convert to NumPy array if necessary</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">):</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;asnumpy&quot;</span><span class="p">):</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
                            <span class="c1"># Convert to PIL Image</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

                            <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">tile_name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="n">mask_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mask coordinates generated in </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">mask_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mask_start_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Save mask coordinates as pickle</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span> <span class="s2">&quot;mask_coordinates.pickle&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="c1"># pickle.dump(self.mask_coordinates, open(out, &quot;wb&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved mask coordinates to </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished Mask Tile Extraction&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SlideCollection.register_slides">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.register_slides">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_slides</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reference_slide</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">microregistration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_non_rigid_registration_dim_px</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">high_res_alignement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">high_res_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers all WSIs in the collection using Valis.</span>

<span class="sd">        Registers all WSIs in the collection and aligns them. Registration can be performed towards a selected</span>
<span class="sd">        referenceWSI or automatically towards a WSI chosen by VALIS. Registration includes rigid and non-rigid</span>
<span class="sd">        registration steps. Optional `microregistration` can be applied to further improve registration quality.</span>
<span class="sd">        The registered slides are saved in the `registration` directory. Intermediate results are stored in the</span>
<span class="sd">        `intermediate_registration_results` directory. Further configuration options such as</span>
<span class="sd">        `max_non_rigid_registration_dim_px` and cropping methods are available.</span>
<span class="sd">        Lastly, an additional, customizable high-resolution alignment can be performed if specified, which allows</span>
<span class="sd">        tailoring the alignment resolution via the `high_res_fraction` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            reference_slide (str): Path to reference slide. If None, the first slide in the collection will be used.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">            microregistration (bool): Boolean determining if microregistration shall be used. Defaults to True.</span>

<span class="sd">            max_non_rigid_registration_dim_px (int): Maximum size of non-rigid registration dimension in pixels.</span>
<span class="sd">                Defaults to 2000.</span>

<span class="sd">            crop (str): Crop method to be used. Defaults to None which results cropping to reference slide if one is</span>
<span class="sd">                provided. If no reference slide is provided, the default crop method is &#39;overlap&#39;.</span>

<span class="sd">            high_res_alignment (bool): Boolean determining if customizable high-resolution alignment shall be</span>
<span class="sd">                performed. Defaults to False.</span>

<span class="sd">            high_res_fraction (float): Fraction of the image to be used for high resolution alignment. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">registration_begin_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">REGISTRATION_DIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_registration_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;intermediate_registration_results&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_registration_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reference_slide</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Registering slides with reference slide </span><span class="si">{</span><span class="n">reference_slide</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">register_slides_with_reference</span><span class="p">(</span>
                <span class="n">slide_src_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">,</span>
                <span class="n">results_dst_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_registration_dir</span><span class="p">,</span>
                <span class="n">referenceSlide</span><span class="o">=</span><span class="n">reference_slide</span><span class="p">,</span>
                <span class="n">microregistration</span><span class="o">=</span><span class="n">microregistration</span><span class="p">,</span>
                <span class="n">max_non_rigid_registration_dim_px</span><span class="o">=</span><span class="n">max_non_rigid_registration_dim_px</span><span class="p">,</span>
                <span class="n">crop</span><span class="o">=</span><span class="n">crop</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">high_res_alignement</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Performing high resolution alignment with </span><span class="si">{</span><span class="n">high_res_fraction</span><span class="si">}</span><span class="s2"> fraction&quot;</span>
            <span class="p">)</span>
            <span class="n">register_slides_high_resolution</span><span class="p">(</span>
                <span class="n">slide_src_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">,</span>
                <span class="n">results_dst_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_registration_dir</span><span class="p">,</span>
                <span class="n">registered_slides_dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span><span class="p">,</span>
                <span class="n">micro_reg_fraction</span><span class="o">=</span><span class="n">high_res_fraction</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registering slides without reference slide&quot;</span><span class="p">)</span>
            <span class="n">register_slides</span><span class="p">(</span>
                <span class="n">slide_src_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir</span><span class="p">,</span>
                <span class="n">results_dst_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_registration_dir</span><span class="p">,</span>
                <span class="n">registered_slides_dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span><span class="p">,</span>
                <span class="n">microregistration</span><span class="o">=</span><span class="n">microregistration</span><span class="p">,</span>
                <span class="n">max_non_rigid_registration_dim_px</span><span class="o">=</span><span class="n">max_non_rigid_registration_dim_px</span><span class="p">,</span>
                <span class="n">crop</span><span class="o">=</span><span class="n">crop</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">registration_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;registered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished image registration of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">registration_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">registration_begin_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating slide paths for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_slide_paths_after_registration</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_slide_paths_after_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update Slide objects to use registered slide files saved in self.registration_dir.</span>
<span class="sd">        Uses original basename to look for the registered file (registration preserves filenames).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Registration directory not set or missing; skipping _update_slide_paths_after_registration.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># First, scan all files in registration_dir recursively and build a mapping from stem -&gt; path</span>
        <span class="n">reg_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">stem</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">reg_files</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
            <span class="n">base_stem</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">orig_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_stem</span> <span class="ow">in</span> <span class="n">reg_files</span><span class="p">:</span>
                <span class="n">reg_path</span> <span class="o">=</span> <span class="n">reg_files</span><span class="p">[</span><span class="n">base_stem</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">slide</span><span class="o">.</span><span class="n">update_slide</span><span class="p">(</span><span class="n">reg_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not update slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">reg_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No registered file found for </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (stem=</span><span class="si">{</span><span class="n">base_stem</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="SlideCollection.tumor_segmentation">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.tumor_segmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tumor_segmentation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">,</span>
        <span class="n">reference_slide</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">],</span>
        <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">inversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs tumor segmentation on the HE WSI in the SlideCollection.</span>

<span class="sd">        Performs tumor segmentation on either a specified reference WSI or the reference WSI selected by the</span>
<span class="sd">        SlideCollection. The segmentation model needs to be passed. By default, segmentation results are saved into the</span>
<span class="sd">        `registration_dir` of the SlideCollection, an optional ouput path can be provided. Model-specific parameters</span>
<span class="sd">        such as `normalization`, or `inversion` can also be passed. Lastly, segmentation_results can be plotted onto</span>
<span class="sd">        the tissue if `plot_results` is set to True.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path (str): Path to segmentation model.</span>

<span class="sd">            reference_slide (str, optional): Path to reference slide. If None, the reference slide of the</span>
<span class="sd">                SlideCollection is used. Defaults to None.</span>

<span class="sd">            tile_size (list, optional): Tile size to be used for segmentation. Defaults to [1024, 1024].</span>

<span class="sd">            output_path (str, optional): Output path for segmentation results. If None, the `registration_dir` of the</span>
<span class="sd">                SlideCollection is used. Defaults to None.</span>

<span class="sd">            normalization (bool, optional): Boolean determining if stain normalization shall be applied. Defaults to</span>
<span class="sd">                False.</span>

<span class="sd">            inversion (bool, optional): Boolean determining if color inversion shall be applied. Defaults to False.</span>

<span class="sd">            plot_results (bool, optional): Boolean determining if segmentation results shall be plotted onto the tissue.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">reference_slide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_slide</span><span class="o">.</span><span class="n">registered_path</span>

        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registration_dir</span>

        <span class="n">run_tumor_segmentation</span><span class="p">(</span>
            <span class="n">reference_slide</span><span class="p">,</span>
            <span class="n">model_path</span><span class="p">,</span>
            <span class="n">tile_size</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">normalization</span><span class="p">,</span>
            <span class="n">inversion</span><span class="p">,</span>
            <span class="n">plot_results</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_mask_to_collection</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;segmented&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_antigen_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds antigen profiles to slides in the collection based on matching names.</span>

<span class="sd">        Args:</span>
<span class="sd">            profile_path (str): Path to antigen profile file. Supported formats are CSV and JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">profile_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="n">profiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">profile_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">profile_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">profiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">profile_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unsupported file format for antigen profile. Must be CSV or JSON&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profiles_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Antigen profile must contain a Name&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_mask</span> <span class="ow">or</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_reference</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">profiles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">antigen_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">antigen_name</span> <span class="ow">in</span> <span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># print(profile.to_dict())</span>
                    <span class="n">slide</span><span class="o">.</span><span class="n">antigen_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Antigen profile&#39;</span><span class="si">{</span><span class="n">antigen_name</span><span class="si">}</span><span class="s2">&#39; added to slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No antigen profile found matching slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="SlideCollection.quantify_all_slides">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.quantify_all_slides">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">quantify_all_slides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_imgs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Quantifies all registered slides sequentially and stores results.</span>

<span class="sd">        Quantifies all slides that were instantiated sequentially with the exception of the reference_slide and the</span>
<span class="sd">        mask_slide. Results are stored as .CSV into the `data_dir`. All previous quantification results in the</span>
<span class="sd">        `quant_res_df` will be reset and the previous .CSV file overwritten.</span>

<span class="sd">        Args:</span>
<span class="sd">            save_imgs (bool): Boolean determining if tiles shall be saved as image during processing. This is necessary</span>
<span class="sd">                if slides shall be reconstructed after processing. Note: storing tiles may require substantial</span>
<span class="sd">                additional storage. Defaults to False.</span>

<span class="sd">            masking_mode (str): Defines how the tumor mask is applied to tiles during quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                  Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                  Offers finer quantification, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">masking_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tile-level&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel-level&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;masking_mode must either be &#39;tile-level&#39; or &#39;pixel-level&#39;. </span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span>
            <span class="p">)</span>
        <span class="n">start_quant_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting quantification of all slides, save_imgs: </span><span class="si">{</span><span class="n">save_imgs</span><span class="si">}</span><span class="s2">, masking_mode: </span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Counter variable for progress tracking</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_mask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_reference</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Analyzing Slide: </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quantify_single_slide</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">save_imgs</span><span class="p">,</span> <span class="n">masking_mode</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end_quant_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished quantification for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">end_quant_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_quant_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;quantified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SlideCollection.quantify_single_slide">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.quantify_single_slide">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">quantify_single_slide</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">save_img</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Quantifies a single slide and appends the results to `quant_res_df`.</span>

<span class="sd">        This function quantifies staining intensities for all tiles of the given slide using multiprocessing. The slide</span>
<span class="sd">        matching the passed slide_name is retrieved from the collection_list and quantified using the quantify_slide</span>
<span class="sd">        function of the Slide class. Results are appended to `quant_res_df`, which is then stored as .CSV in self.</span>
<span class="sd">        `data_dir` and as .PICKLE in `pickle_dir`. Existing .CSV/.PICKLE files are overwritten.</span>
<span class="sd">        For more information on quantification checkout Slide.quantify_slide() function in the slide.py.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide_name (str): Name of the slide to be processed.</span>

<span class="sd">            save_img (bool): Boolean determining if tiles shall be saved during processing. Necessary if slide shall be</span>
<span class="sd">                reconstructed later on. However, storing images will require addition storage. Defaults to False.</span>

<span class="sd">            masking_mode (str): Defines how the tumor mask is applied to tiles during quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                   Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                   Offers finer quantification, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">masking_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tile-level&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel-level&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;masking_mode must either be &#39;tile-level&#39; or &#39;pixel-level&#39;. </span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;registered&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Slides must be registered before quantification. Please call register_slides() before quantification.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;segmented&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Tumor segmentation must be performed before quantification.</span><span class="se">\</span>
<span class="s2">                      Please call tumor_segmentation() before quantification.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting mask coordinates before quantification&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_mask_tile_coordinates</span><span class="p">()</span>

        <span class="n">slide</span> <span class="o">=</span> <span class="p">[</span><span class="n">slide</span> <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="k">if</span> <span class="n">slide</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slide_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create directories for images if they are to be saved.</span>
        <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
            <span class="n">dab_tile_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">DAB_TILE_DIR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">masking_mode</span> <span class="o">==</span> <span class="s2">&quot;pixel-level&quot;</span><span class="p">:</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">quantify_slide</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span>
                    <span class="n">save_img</span><span class="p">,</span>
                    <span class="n">dab_tile_dir</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">tiles</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">masking_mode</span> <span class="o">==</span> <span class="s2">&quot;tile-level&quot;</span><span class="p">:</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">quantify_slide</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span>
                    <span class="n">save_img</span><span class="p">,</span>
                    <span class="n">dab_tile_dir</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">masking_mode</span> <span class="o">==</span> <span class="s2">&quot;pixel-level&quot;</span><span class="p">:</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">quantify_slide</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">tiles</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">masking_mode</span> <span class="o">==</span> <span class="s2">&quot;tile-level&quot;</span><span class="p">:</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">quantify_slide</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_coordinates</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># slide_summary_series = pd.Series(slide.quantification_summary)</span>
        <span class="n">slide_name_summary</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">quantification_summary</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>

        <span class="c1"># Check if a row with the same &#39;Name&#39; exists</span>
        <span class="n">existing_row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slide_name_summary</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_row_index</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Overwrite the existing row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">existing_row_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">quantification_summary</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Append the new row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">slide</span><span class="o">.</span><span class="n">quantification_summary</span><span class="p">]),</span>
                <span class="p">],</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Sort the DataFrame by the &#39;Name&#39; column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coverage (%)&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_quantification_results</span><span class="p">(</span><span class="n">masking_mode</span><span class="o">=</span><span class="n">masking_mode</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">save_quantification_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masking_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores `quant_res_df` as .CSV for and .PICKLE in `data_dir` and `pickle_dir`, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">save_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2">_quantification_results.csv&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span> <span class="s2">&quot;quantification_results.pickle&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">quantification_results</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span>
                <span class="p">)</span>
            <span class="n">save_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully saved quantification results to </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">save_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">save_start_time</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No quantification results were found. Please call quantify_all_slides() to quantify all slides </span><span class="se">\</span>
<span class="s2">                    in this slide collection or call quantify_single_slide() to quantify a single slide.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="SlideCollection.generate_antigen_pair_combinations">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.generate_antigen_pair_combinations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_antigen_pair_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates all possible antigen pairs and analyzes antigen co-expression for all pairs. Results are stored</span>
<span class="sd">        in `dual_antigen_expressions`.</span>

<span class="sd">        Args:</span>
<span class="sd">            masking_mode (str): Determines the mode for mask application that was used for quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                   Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                   Offers finer co-expression evaluation, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dual_expression_time_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">DUAL_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span>
        <span class="p">)</span>
        <span class="c1"># Filter out mask and reference slides</span>
        <span class="n">filtered_slides</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">slide</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_mask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_reference</span>
        <span class="p">]</span>

        <span class="c1"># Generate all possible pairs of the filtered slides</span>
        <span class="n">slide_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">filtered_slides</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Pass each combination to the compute_dual_antigen_combination method</span>
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">slide_combinations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_antigen_pair</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">masking_mode</span><span class="o">=</span><span class="n">masking_mode</span><span class="p">)</span>
        <span class="n">dual_expression_time_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished dual antigen expression analysis in </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">dual_expression_time_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dual_expression_time_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;dual_antigen_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SlideCollection.generate_antigen_triplet_combinations">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.generate_antigen_triplet_combinations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_antigen_triplet_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates all possible antigen triplets and analyzes antigen co-expression for all triplets. Results are stored</span>
<span class="sd">        in `triplet_antigen_expressions`.</span>

<span class="sd">        Args:</span>
<span class="sd">            masking_mode (str): Determines the mode for mask application that was used for quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                   Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                   Offers finer co-expression evaluation, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">triplet_expression_time_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">TRIPLET_ANTIGEN_EXPRESSIONS_COLUMN_NAMES</span>
        <span class="p">)</span>
        <span class="c1"># Filter out mask and reference slides</span>
        <span class="n">filtered_slides</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">slide</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_mask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">is_reference</span>
        <span class="p">]</span>

        <span class="c1"># Generate all possible triplets of the filtered slides</span>
        <span class="n">slide_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">filtered_slides</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Pass each combination to the compute_triplet_antigen_combinations method</span>
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">slide_combinations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_antigen_triplet</span><span class="p">(</span>
                <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">combo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">masking_mode</span><span class="o">=</span><span class="n">masking_mode</span>
            <span class="p">)</span>
        <span class="n">triplet_expression_time_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished triplet antigen expression analysis in </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">triplet_expression_time_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">triplet_expression_time_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;triplet_antigen_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SlideCollection.evaluate_antigen_pair">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.evaluate_antigen_pair">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_antigen_pair</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">slide1</span><span class="p">,</span> <span class="n">slide2</span><span class="p">,</span> <span class="n">save_img</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyzes the antigen co-expression for a pair of two slides.</span>

<span class="sd">        Analyzes antigen co-expressions for each tile for the given pair of slides using multiprocesing based on the</span>
<span class="sd">        antigen-specific thresholds of each slide. Results from each of the tiles are summarized, stored in</span>
<span class="sd">        `dual_antigen_expressions` and saved as CSV in `data_dir` as well as PICKLE in `pickle_dir`. For more detailed</span>
<span class="sd">        explanation of the co-expression results see `SlideCollection.triplet_antigen_expressions`.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide1 (Slide): Slide Object for slide 1.</span>

<span class="sd">            slide2 (Slide): Slide Object for slide 2.</span>

<span class="sd">            save_img (bool):  Boolean determining if tiles shall be saved during processing. Necessary if slide shall be</span>
<span class="sd">                reconstructed later on. However, storing images will require additional storage. Defaults to False.</span>

<span class="sd">            masking_mode (str): Determines the mode for mask application that was used for quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                   Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                   Offers finer co-expression evaluation, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create directory for pair of slides</span>
        <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
            <span class="c1"># Create Colocalization directory if it does not exist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">COLOCALIZATION</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create sub-directory for slide pair</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create iterable for multiprocessing</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tilename&quot;</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">slide2</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tilename&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">_dict1</span> <span class="o">=</span> <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_dict2</span> <span class="o">=</span> <span class="n">slide2</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">iterable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">_dict1</span><span class="p">,</span>
                        <span class="n">_dict2</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">slide1</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span> <span class="n">slide2</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">],</span>
                        <span class="nb">dir</span><span class="p">,</span>
                        <span class="n">save_img</span><span class="p">,</span>
                        <span class="n">masking_mode</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Init dict for results of each tile</span>
        <span class="n">comparison_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">exe</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">evaluate_antigen_pair_tile</span><span class="p">,</span>
                    <span class="n">iterable</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calculating Coverage of Slide &quot;</span>
                <span class="o">+</span> <span class="n">slide1</span><span class="o">.</span><span class="n">name</span>
                <span class="o">+</span> <span class="s2">&quot; &amp; &quot;</span>
                <span class="o">+</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="n">comparison_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Finished antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Finished antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize_antigen_combinations</span><span class="p">(</span>
            <span class="n">comparison_dict</span><span class="p">,</span>
            <span class="p">[</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
            <span class="n">antigen_profiles</span><span class="o">=</span><span class="p">[</span><span class="n">slide1</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span> <span class="n">slide2</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_antigen_combinations</span><span class="p">(</span><span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;dual&quot;</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="n">masking_mode</span><span class="p">)</span></div>


<div class="viewcode-block" id="SlideCollection.evaluate_antigen_triplet">
<a class="viewcode-back" href="../../../slide_collection.html#cubats.slide_collection.slide_collection.SlideCollection.evaluate_antigen_triplet">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_antigen_triplet</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">slide1</span><span class="p">,</span> <span class="n">slide2</span><span class="p">,</span> <span class="n">slide3</span><span class="p">,</span> <span class="n">save_img</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyzes the antigen co-expression for a triplet of three slides.</span>

<span class="sd">        Analyzes antigen co-expressions for each of tiles of the given triplet of slides using Multiprocessing based on</span>
<span class="sd">        the antigen-specific thresholds of each slide. Results from each of the tiles are summarized, stored in</span>
<span class="sd">        `triplet_antigen_expressions` and saved as CSV in `data_dir` as well as PICKLE in `pickle_dir`. For more</span>
<span class="sd">        detailed explanation of the co-expression results see `SlideCollection.triplet_antigen_expressions`.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide1 (Slide): Slide Object for slide 1.</span>

<span class="sd">            slide2 (Slide): Slide Object for slide 2.</span>

<span class="sd">            slide3 (Slide): Slide Object for slide 3.</span>

<span class="sd">            save_img (bool):  Boolean determining if tiles shall be saved during processing. Necessary if slide shall be</span>
<span class="sd">                reconstructed later on. However, storing images will require additional storage. Defaults to False.</span>

<span class="sd">            masking_mode (str): Determines the mode for mask application that was used for quantification.</span>

<span class="sd">                - `tile-level` (default): Applies the mask coarsly - tiles overlapping the mask are fully included.</span>
<span class="sd">                   Recommended when registration quality is lower (e.g. high median rTRE).</span>

<span class="sd">                - `pixel-level`: Applies the mask precisely at pixel level - only masked pixels are included.</span>
<span class="sd">                   Offers finer co-expression evaluation, but is more sensitive to registration errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create directory for triplet of slides</span>
        <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
            <span class="c1"># Create Colocalization directory if it does not exist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">COLOCALIZATION</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create sub-directory for slide triplet</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">colocalization_dir</span><span class="p">,</span>
                <span class="p">(</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create iterable for multiprocessing</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tilename&quot;</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">slide2</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tilename&quot;</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">slide3</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tilename&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">_dict1</span> <span class="o">=</span> <span class="n">slide1</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_dict2</span> <span class="o">=</span> <span class="n">slide2</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_dict3</span> <span class="o">=</span> <span class="n">slide3</span><span class="o">.</span><span class="n">detailed_quantification_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">iterable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">_dict1</span><span class="p">,</span>
                        <span class="n">_dict2</span><span class="p">,</span>
                        <span class="n">_dict3</span><span class="p">,</span>
                        <span class="p">[</span>
                            <span class="n">slide1</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
                            <span class="n">slide2</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
                            <span class="n">slide3</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">dirname</span><span class="p">,</span>
                        <span class="n">save_img</span><span class="p">,</span>
                        <span class="n">masking_mode</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Init dict for results of each tile</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">comparison_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># Process tiles using multiprocessing</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">exe</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">evaluate_antigen_triplet_tile</span><span class="p">,</span> <span class="n">iterable</span><span class="p">),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calculating Coverage of Slides &quot;</span>
                <span class="o">+</span> <span class="n">slide1</span><span class="o">.</span><span class="n">name</span>
                <span class="o">+</span> <span class="s2">&quot; &amp; &quot;</span>
                <span class="o">+</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span>
                <span class="o">+</span> <span class="s2">&quot; &amp; &quot;</span>
                <span class="o">+</span> <span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="n">comparison_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Finished antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> minutes.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Finished antigen analysis for: </span><span class="si">{</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize_antigen_combinations</span><span class="p">(</span>
            <span class="n">comparison_dict</span><span class="p">,</span>
            <span class="p">[</span><span class="n">slide1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">slide2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">slide3</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
            <span class="n">antigen_profiles</span><span class="o">=</span><span class="p">[</span>
                <span class="n">slide1</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
                <span class="n">slide2</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
                <span class="n">slide3</span><span class="o">.</span><span class="n">antigen_profile</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_antigen_combinations</span><span class="p">(</span><span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;triplet&quot;</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="n">masking_mode</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_antigen_combinations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">comparison_dict</span><span class="p">,</span> <span class="n">slide_names</span><span class="p">,</span> <span class="n">antigen_profiles</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarizes co-expression results of an antigen pair or triplet.</span>

<span class="sd">        Args:</span>
<span class="sd">            - comparison_dict (dict): Dictionary containing the co-expression results for each tile of the combination.</span>

<span class="sd">            - slide_names (str): Names of all slides of the combination.</span>

<span class="sd">            - antigen_profiles (list): List of all antigen profiles of the slides in the combination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_tiles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_total_coverage</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_total_overlap</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_total_complement</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_high_overlap</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_high_complement</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_pos_overlap</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_pos_complement</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_low_overlap</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_low_complement</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_negative</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_tissue</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_background</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_mask</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">sum_non_mask</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">error1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comparison_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">processed_tiles</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">sum_total_coverage</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Total Coverage&quot;</span><span class="p">]</span>
                <span class="n">sum_total_overlap</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Total Overlap&quot;</span><span class="p">]</span>
                <span class="n">sum_total_complement</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Total Complement&quot;</span><span class="p">]</span>
                <span class="n">sum_high_overlap</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;High Positive Overlap&quot;</span><span class="p">]</span>
                <span class="n">sum_high_complement</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;High Positive Complement&quot;</span><span class="p">]</span>
                <span class="n">sum_pos_overlap</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Medium Positive Overlap&quot;</span><span class="p">]</span>
                <span class="n">sum_pos_complement</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Medium Positive Complement&quot;</span><span class="p">]</span>
                <span class="n">sum_low_overlap</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Low Positive Overlap&quot;</span><span class="p">]</span>
                <span class="n">sum_low_complement</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Low Positive Complement&quot;</span><span class="p">]</span>
                <span class="n">sum_negative</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Negative&quot;</span><span class="p">]</span>
                <span class="n">sum_tissue</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Tissue&quot;</span><span class="p">]</span>
                <span class="n">sum_background</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Background / No Tissue&quot;</span><span class="p">]</span>
                <span class="n">sum_mask</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Mask Area&quot;</span><span class="p">]</span>
                <span class="n">sum_non_mask</span> <span class="o">+=</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Non-mask Area&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Flag&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">error1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">comparison_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Flag&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">error2</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">processed_tiles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sum_total_coverage</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_total_overlap</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_total_complement</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_high_overlap</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_high_complement</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_pos_overlap</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_pos_complement</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_low_overlap</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_low_complement</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_negative</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_tissue</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_background</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_mask</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
            <span class="n">sum_non_mask</span> <span class="o">/=</span> <span class="n">processed_tiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_total_coverage</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_total_overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_total_complement</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_high_overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_high_complement</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_pos_overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_pos_complement</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_low_overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_low_complement</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_negative</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_tissue</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_background</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sum_non_mask</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="n">total_error</span> <span class="o">=</span> <span class="n">error1</span> <span class="o">+</span> <span class="n">error2</span>
        <span class="n">total_processed_tiles</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">processed_tiles</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_dict</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">overlap_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Slide 1&quot;</span><span class="p">:</span> <span class="n">slide_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Slide 2&quot;</span><span class="p">:</span> <span class="n">slide_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">overlap_dict</span><span class="p">[</span><span class="s2">&quot;Slide 3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slide_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">overlap_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Total Coverage (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_total_coverage</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Total Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_total_overlap</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Total Complement (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_total_complement</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;High Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_high_overlap</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;High Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_high_complement</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Medium Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_pos_overlap</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Medium Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_pos_complement</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Low Positive Overlap (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_low_overlap</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Low Positive Complement (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_low_complement</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Negative Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_negative</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Total Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_tissue</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Background / No Tissue (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_background</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_mask</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Non-mask Area (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_non_mask</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Total Processed Tiles (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_processed_tiles</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Total Error (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">((</span><span class="n">total_error</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_dict</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">2</span>
                <span class="p">),</span>
                <span class="s2">&quot;Error1 (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">error1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_dict</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Error2 (%)&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">error2</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_dict</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;Thresholds1&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;high_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;medium_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;low_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="mi">235</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Thresholds2&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;high_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;medium_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;low_positive_threshold&quot;</span><span class="p">],</span>
                    <span class="mi">235</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">antigen_profiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">overlap_dict</span><span class="p">[</span><span class="s2">&quot;Thresholds3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;high_positive_threshold&quot;</span><span class="p">],</span>
                <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;medium_positive_threshold&quot;</span><span class="p">],</span>
                <span class="n">antigen_profiles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;low_positive_threshold&quot;</span><span class="p">],</span>
                <span class="mi">235</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">overlap_dict</span><span class="p">])],</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                <span class="n">by</span><span class="o">=</span><span class="s2">&quot;Total Coverage (%)&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">overlap_dict</span><span class="p">])],</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                <span class="n">by</span><span class="o">=</span><span class="s2">&quot;Total Coverage (%)&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_antigen_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;dual&quot;</span><span class="p">,</span> <span class="n">masking_mode</span><span class="o">=</span><span class="s2">&quot;tile-level&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save antigen combination results as CSV and PICKLE.</span>

<span class="sd">        Args:</span>
<span class="sd">            result_type (str): Type of antigen combination results to save. Can be &quot;dual&quot; or &quot;triplet&quot;.</span>

<span class="sd">            masking_mode (str): Mode of mask application for consistent file naming with the applied mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="s2">&quot;dual&quot;</span><span class="p">:</span>
            <span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual_antigen_expressions</span>
            <span class="n">csv_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2">_dual_antigen_expressions.csv&quot;</span>
            <span class="n">pickle_filename</span> <span class="o">=</span> <span class="s2">&quot;dual_antigen_expressions.pickle&quot;</span>
        <span class="k">elif</span> <span class="n">result_type</span> <span class="o">==</span> <span class="s2">&quot;triplet&quot;</span><span class="p">:</span>
            <span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triplet_antigen_results</span>
            <span class="n">csv_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masking_mode</span><span class="si">}</span><span class="s2">_triplet_antigen_expressions.csv&quot;</span>
            <span class="n">pickle_filename</span> <span class="o">=</span> <span class="s2">&quot;triplet_antigen_expressions.pickle&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid result_type. Must be &#39;dual&#39; or &#39;triplet&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Save results as CSV</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">csv_filename</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save results as PICKLE</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_dir</span><span class="p">,</span> <span class="n">pickle_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">summary_df</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Moritz Dinser &amp; Daniel Hieber.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>